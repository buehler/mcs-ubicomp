<html>
  <head> </head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <script src="model.js"></script>
  <body>
    <canvas id="myChart" style="width: 100%; max-width: 700px"></canvas>
    <script src="https://www.espruino.com/js/uart.js"></script>
    <script>
      function extractDataFromResponse(response) {
        if (response != null) {
          return response.split(',').map(parseFloat);
        }
      }

      function doClassification(data) {
        const classification = classify(data);
        document.getElementById('result').innerHTML = JSON.stringify(classification);
      }

      let chart;
      function makeChart(data) {
        if (!!!chart) {
          const ctx = document.getElementById('datachart');
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [...Array(21).keys()].slice(1),
              datasets: [
                {
                  label: 'x',
                  data: Array(20),
                  borderColor: 'red',
                  backgroundColor: 'transparent',
                },
                {
                  label: 'y',
                  data: Array(20),
                  borderColor: 'blue',
                  backgroundColor: 'transparent',
                },
                {
                  label: 'z',
                  data: Array(20),
                  borderColor: 'green',
                  backgroundColor: 'transparent',
                },
              ],
            },
          });
        }

        for (let i = 0; i < 60; i++) {
          chart.data.datasets[i % 3].data[i % 20] = data[i];
        }

        chart.update();
      }

      function getData() {
        UART.eval('dumpData()', function (response) {
          document.getElementById('sensordata').value = response;
          UART.close();
          var data = extractDataFromResponse(response);
          makeChart(data);
          doClassification(data);
        });
      }

      //This helper function copies the accelerometer data to the clipboard for testing
      function copy() {
        var copyText = document.getElementById('sensordata');
        copyText.select();
        copyText.setSelectionRange(0, 99999); /* For mobile devices */
        navigator.clipboard.writeText(copyText.value);
        alert('Copied the text: ' + copyText.value);
      }

      function exec() {
        const text = document.getElementById('sensordata');
        const data = extractDataFromResponse(text.value);
        makeChart(data);
        doClassification(data);
      }
    </script>

    <div>
      <button style="margin: 20px" onclick="getData()">Retrieve and process</button>
      <input style="margin: 20px; width: 500px" type="text" value=".." id="sensordata" />
      <button onclick="copy()">Copy</button>
      <button onclick="exec()">Exec</button>
    </div>
    <div>
      <label style="margin: 20px; width: 500px">Classifer output: </label>
      <label id="result"></label>
    </div>
    <div>
      <canvas id="datachart"></canvas>
    </div>
  </body>
</html>
